<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CampusFind - Student Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: url('gsss.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: "Segoe UI", sans-serif;
    }
    .dashboard-box {
      background: rgba(255,255,255,0.95);
      margin: 30px auto;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }
    .card {
      transition: 0.3s;
      cursor: pointer;
      border: none;
      border-radius: 12px;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .search-box {
      border-radius: 25px;
      padding: 12px 20px;
      border: 2px solid #e9ecef;
    }
    .search-box:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.1);
    }
    .new-item-highlight {
      border: 2px solid #198754;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(25, 135, 84, 0); }
      100% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0); }
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg px-3" style="background:#0d6efd;">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold text-white">
        <i class></i>CampusFind - Student Dashboard
      </span>
      <div class="d-flex align-items-center">
        <span class="text-white me-3 d-none d-md-block">
          <i class="bi bi-person-circle me-1"></i>
          <span id="userEmail"></span>
        </span>
        <button onclick="logout()" class="btn btn-sm btn-danger logout-btn">
          <i class="bi bi-box-arrow-right me-1"></i> Logout
        </button>
      </div>
    </div>
  </nav>

  <div class="container dashboard-box">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
      <div class="flex-grow-1">
        <input type="text" id="searchInput" class="form-control search-box" placeholder="üîç Search by item name...">
      </div>
      <div class="d-flex gap-2">
        <a href="report.html" class="btn btn-primary px-4">
          <i class="bi bi-plus-circle me-2"></i> Report Found Item
        </a>
        <a href="report-lost.html" class="btn btn-warning px-4">
          <i class="bi bi-exclamation-triangle me-2"></i> Report Lost Item
        </a>
      </div>
    </div>

    <div class="row" id="itemList"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE_URL = 'http://localhost:5000';
    let allItems = [];

    // Check if user is logged in
    function checkAuth() {
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('role');
      const userEmail = localStorage.getItem('userEmail');
      
      if (!token || role !== 'student') {
        window.location.href = 'login.html';
        return false;
      }
      
      // Display user email
      if (userEmail) {
        document.getElementById('userEmail').textContent = userEmail;
      }
      
      return true;
    }

    // Fetch only approved items from backend (items that admin has confirmed receipt)
    async function fetchItems() {
      const container = document.getElementById("itemList");
      
      try {
        const res = await fetch(`${API_BASE_URL}/api/items/available`);
        if (!res.ok) throw new Error("Server returned an error");
        allItems = await res.json();
        
        displayItems(allItems);
      } catch (err) {
        console.error("‚ùå Failed to load items from server:", err);
        container.innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger text-center fs-6">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Unable to connect to the server.<br>
              <small>Please ensure the backend is running on port 5000.</small>
            </div>
          </div>
        `;
      }
    }

    // Display items dynamically
    function displayItems(items) {
      const container = document.getElementById("itemList");
      container.innerHTML = "";
      
      if (items.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <p class="text-muted fs-5 mt-3">No lost items found</p>
            <p class="text-muted">Items reported by students will appear here after admin verification.</p>
          </div>
        `;
        return;
      }

      items.forEach((item, index) => {
        const col = document.createElement("div");
        col.className = "col-md-4 mb-4";
        
        // Handle image URL - prepend base URL if it's a relative path
        let imageUrl = item.imageUrl || 'placeholder.jpg';
        if (item.imageUrl && !item.imageUrl.startsWith('http')) {
          imageUrl = `${API_BASE_URL}${item.imageUrl}`;
        }
        
        col.innerHTML = `
          <div class="card h-100 shadow-sm" data-name="${item.itemName}">
            <div class="position-relative">
              <img src="${imageUrl}" class="card-img-top" alt="${item.itemName}" 
                   style="height:200px;object-fit:cover; border-top-left-radius: 12px; border-top-right-radius: 12px;"
                   onerror="this.src='placeholder.jpg'">
              <div class="position-absolute top-0 end-0 m-2">
                <span class="badge bg-success">Available</span>
              </div>
            </div>
            <div class="card-body d-flex flex-column">
              <h5 class="card-title text-primary">${item.itemName}</h5>
              <div class="card-text flex-grow-1">
                <p class="text-muted mb-1"><i class="bi bi-calendar me-1"></i>${new Date(item.receiptConfirmedAt).toLocaleDateString()}</p>
              </div>
              <div class="mt-3">
                <button class="btn btn-primary w-100">
                  <i class="bi bi-hand-thumbs-up me-2"></i>Claim Item
                </button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(col);
      });

      // Click to open claim.html
      document.querySelectorAll(".card").forEach(card => {
        card.addEventListener("click", () => {
          const itemName = card.getAttribute("data-name");
          window.location.href = `claim.html?itemName=${encodeURIComponent(itemName)}`;
        });
      });
    }

    // Search functionality (Searches by item name)
    document.getElementById("searchInput").addEventListener("input", function() {
      const text = this.value.toLowerCase();
      const filtered = allItems.filter(item =>
        item.itemName.toLowerCase().includes(text)
      );
      displayItems(filtered);
    });

    // Logout function
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('userEmail');
      window.location.href = 'login.html';
    }

    // Initialize when page loads
    document.addEventListener("DOMContentLoaded", function() {
      if (checkAuth()) {
        fetchItems();
      }
    });
  </script>
</body>
</html>