<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CampusFind - Forgot Password</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      background: url("gsss.jpg") no-repeat center center fixed;
      background-size: cover;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Segoe UI", sans-serif;
    }
    .password-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1rem;
      padding: 2rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }
    .form-control {
      border-radius: 8px;
      border: 1px solid #dee2e6;
      transition: all 0.3s ease;
    }
    .form-control:focus {
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
      border-color: #0d6efd;
    }
    h2 {
      text-align: center;
      color: #0d6efd;
      font-weight: 700;
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
    }
    .btn-primary {
      width: 100%;
      border-radius: 8px;
      padding: 12px;
      font-weight: 600;
      background: linear-gradient(135deg, #0d6efd, #0a58ca);
      border: none;
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);
    }
    .text-center a {
      color: #0d6efd;
      text-decoration: none;
      font-weight: 500;
    }
    .text-center a:hover {
      text-decoration: underline;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .countdown {
      font-size: 0.8rem;
      color: #dc3545;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="password-card">
    <h2>Reset Password</h2>

    <!-- Step 1: Enter Email -->
    <div class="step active" id="step1">
      <form id="emailForm">
        <div class="mb-3">
          <label for="email" class="form-label fw-semibold">Email Address</label>
          <input
            type="email"
            id="email"
            class="form-control"
            placeholder="Enter your registered email"
            required
          />
        </div>

        <button type="submit" class="btn btn-primary" id="sendOtpBtn">
          <i class="bi bi-send me-2"></i>Send OTP
        </button>

        <p class="text-center mt-3 mb-0">
          Remember your password?
          <a href="login.html">Login here</a>
        </p>
      </form>
    </div>

    <!-- Step 2: Verify OTP -->
    <div class="step" id="step2">
      <form id="otpForm">
        <div class="mb-3">
          <label for="otp" class="form-label fw-semibold">Enter OTP</label>
          <input
            type="text"
            id="otp"
            class="form-control"
            placeholder="Enter 4-digit OTP"
            maxlength="4"
            required
          />
          <div class="countdown" id="countdown"></div>
          <small class="text-muted">OTP sent to your email. Valid for 10 minutes.</small>
        </div>

        <button type="submit" class="btn btn-primary" id="verifyOtpBtn">
          <i class="bi bi-check-circle me-2"></i>Verify OTP
        </button>

        <p class="text-center mt-3 mb-0">
          <a href="javascript:void(0)" onclick="showStep(1)">Back to Email</a>
        </p>
      </form>
    </div>

    <!-- Step 3: Reset Password -->
    <div class="step" id="step3">
      <form id="resetForm">
        <div class="mb-3">
          <label for="newPassword" class="form-label fw-semibold">New Password</label>
          <input
            type="password"
            id="newPassword"
            class="form-control"
            placeholder="Enter new password"
            required
          />
        </div>

        <div class="mb-3">
          <label for="confirmPassword" class="form-label fw-semibold">Confirm Password</label>
          <input
            type="password"
            id="confirmPassword"
            class="form-control"
            placeholder="Confirm new password"
            required
          />
        </div>

        <button type="submit" class="btn btn-primary" id="resetBtn">
          <i class="bi bi-key me-2"></i>Reset Password
        </button>

        <p class="text-center mt-3 mb-0">
          <a href="javascript:void(0)" onclick="showStep(2)">Back to OTP</a>
        </p>
      </form>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:5000';
    let currentEmail = '';
    let countdownTimer;

    function showStep(stepNumber) {
      // Hide all steps
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
      });
      
      // Show the selected step
      document.getElementById(`step${stepNumber}`).classList.add('active');
    }

    function startCountdown(seconds) {
      clearInterval(countdownTimer);
      let remaining = seconds;
      const countdownDiv = document.getElementById('countdown');
      
      countdownTimer = setInterval(() => {
        const minutes = Math.floor(remaining / 60);
        const secs = remaining % 60;
        countdownDiv.textContent = `OTP expires in: ${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        
        if (remaining <= 0) {
          clearInterval(countdownTimer);
          countdownDiv.textContent = 'OTP has expired';
        } else {
          remaining--;
        }
      }, 1000);
    }

    // Step 1: Send OTP
    document.getElementById("emailForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value.trim();
      const sendOtpBtn = document.getElementById("sendOtpBtn");

      try {
        sendOtpBtn.disabled = true;
        sendOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

        const response = await fetch(`${API_BASE_URL}/api/forgot-password`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });

        const data = await response.json();

        if (response.ok) {
          currentEmail = email;
          showStep(2);
          startCountdown(600); // 10 minutes
          alert('OTP sent successfully to your email!');
        } else {
          throw new Error(data.message || "Failed to send OTP");
        }
      } catch (error) {
        console.error("❌ Error:", error);
        alert(error.message || "Server error. Please try again.");
      } finally {
        sendOtpBtn.disabled = false;
        sendOtpBtn.innerHTML = '<i class="bi bi-send me-2"></i>Send OTP';
      }
    });

    // Step 2: Verify OTP
    document.getElementById("otpForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const otp = document.getElementById("otp").value.trim();
      const verifyOtpBtn = document.getElementById("verifyOtpBtn");

      try {
        verifyOtpBtn.disabled = true;
        verifyOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verifying...';

        const response = await fetch(`${API_BASE_URL}/api/verify-otp`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: currentEmail, otp }),
        });

        const data = await response.json();

        if (response.ok) {
          showStep(3);
          clearInterval(countdownTimer);
        } else {
          throw new Error(data.message || "Invalid OTP");
        }
      } catch (error) {
        console.error("❌ Error:", error);
        alert(error.message || "Server error. Please try again.");
      } finally {
        verifyOtpBtn.disabled = false;
        verifyOtpBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Verify OTP';
      }
    });

    // Step 3: Reset Password
    document.getElementById("resetForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const newPassword = document.getElementById("newPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      const resetBtn = document.getElementById("resetBtn");

      if (newPassword !== confirmPassword) {
        alert("Passwords do not match!");
        return;
      }

      if (newPassword.length < 8) {
        alert("Password must be at least 8 characters long!");
        return;
      }

      try {
        resetBtn.disabled = true;
        resetBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resetting...';

        const response = await fetch(`${API_BASE_URL}/api/reset-password`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            email: currentEmail, 
            otp: document.getElementById("otp").value.trim(),
            newPassword 
          }),
        });

        const data = await response.json();

        if (response.ok) {
          alert("Password reset successfully! You can now login with your new password.");
          window.location.href = "login.html";
        } else {
          throw new Error(data.message || "Failed to reset password");
        }
      } catch (error) {
        console.error("❌ Error:", error);
        alert(error.message || "Server error. Please try again.");
      } finally {
        resetBtn.disabled = false;
        resetBtn.innerHTML = '<i class="bi bi-key me-2"></i>Reset Password';
      }
    });
  </script>
</body>
</html>